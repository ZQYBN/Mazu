"use strict";var _baseComponent=_interopRequireDefault(require("../helpers/baseComponent")),_classNames2=_interopRequireDefault(require("../helpers/libs/classNames")),_styleToCssString=_interopRequireDefault(require("../helpers/libs/styleToCssString")),_arrayTreeFilter=_interopRequireDefault(require("../helpers/libs/arrayTreeFilter")),_fieldNamesBehavior=_interopRequireDefault(require("../helpers/mixins/fieldNamesBehavior"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,r)}return i}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(i,!0).forEach(function(e){_defineProperty(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ownKeys(i).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function _objectWithoutProperties(e,t){if(null==e)return{};var i,r,a=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)i=n[r],0<=t.indexOf(i)||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var i,r,a={},n=Object.keys(e);for(r=0;r<n.length;r++)i=n[r],0<=t.indexOf(i)||(a[i]=e[i]);return a}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var WUX_CASCADER_VIEW="wux-cascader-view";(0,_baseComponent.default)({behaviors:[_fieldNamesBehavior.default],externalClasses:["wux-scroll-view-class"],properties:{prefixCls:{type:String,value:"wux-cascader-view"},defaultValue:{type:Array,value:[]},value:{type:Array,value:[]},controlled:{type:Boolean,value:!1},options:{type:Array,value:[]},full:{type:Boolean,value:!1},placeholder:{type:String,value:"请选择"},height:{type:[String,Number],value:"auto"},skipAnimation:{type:Boolean,value:!1}},data:{activeOptions:[],activeIndex:0,bodyStyle:"",activeValue:[],showOptions:[],scrollViewStyle:""},computed:{classes:["prefixCls, full",function(e,t){return{wrap:(0,_classNames2.default)(e),hd:"".concat(e,"__hd"),bd:"".concat(e,"__bd"),innerScroll:(0,_classNames2.default)("".concat(e,"__inner-scroll"),_defineProperty({},"".concat(e,"__inner-scroll--full"),t)),scrollView:"".concat(e,"__scroll-view"),ft:"".concat(e,"__ft")}}]},observers:{value:function(e){this.data.controlled&&(this.setData({activeValue:e}),this.getCurrentOptions(e))},options:function(){this.getCurrentOptions(this.data.activeValue)},height:function(e){this.updateStyle(e)}},methods:{getActiveOptions:function(i){var e=this.data.options,r=this.getFieldName("value"),t=this.getFieldName("children");return(0,_arrayTreeFilter.default)(e,function(e,t){return e[r]===i[t]},{childrenKeyName:t})},getShowOptions:function(e){var t=this.data.options,i=this.getFieldName("children"),r=this.getActiveOptions(e).map(function(e){return e[i]}).filter(function(e){return!!e});return[t].concat(_toConsumableArray(r))},getMenus:function(e,t){var i=0<arguments.length&&void 0!==e?e:[],r=1<arguments.length?t:void 0,a=this.data.placeholder,n=this.getActiveOptions(i);if(r){var o,s=this.getFieldName("value"),l=this.getFieldName("label");n.push((_defineProperty(o={},s,WUX_CASCADER_VIEW),_defineProperty(o,l,a),o))}return n},getNextActiveValue:function(e,t){var i=this.data.activeValue;return(i=i.slice(0,t+1))[t]=e,i},updated:function(e,t,i,r){var a=this.getFieldName("value"),n=this.getFieldName("children"),o=e&&e[n]&&0<e[n].length,s=this.getNextActiveValue(e[a],t),l=this.getMenus(s,o),u=l.length-1,c=this.getShowOptions(s),h={activeValue:s,activeOptions:l,activeIndex:u,showOptions:c};(o||s.length===c.length&&(t=Math.max(0,t-1)))&&(h.bodyStyle=this.getTransform(t+1),h.showOptions=c),i&&this.setCascaderView(h),"function"==typeof r&&r.call(this,e,s)},getCurrentOptions:function(e){var t=0<arguments.length&&void 0!==e?e:this.data.activeValue,i=Math.max(0,t.length-1),r=this.getActiveOptions(t),a=r[i];if(a)this.updated(a,i,!0);else{var n,o=this.getFieldName("value"),s=this.getFieldName("label");r.push((_defineProperty(n={},o,WUX_CASCADER_VIEW),_defineProperty(n,s,this.data.placeholder),n));var l={showOptions:this.getShowOptions(t),activeOptions:r,activeIndex:r.length-1,bodyStyle:""};this.setCascaderView(l)}},setCascaderView:function(e){var t=this,i=e.activeOptions,r=_objectWithoutProperties(e,["activeOptions"]);this.setData({activeOptions:i},function(){t.data.activeIndex!==r.activeIndex&&t.triggerEvent("tabsChange",{index:r.activeIndex}),t.setData(r)})},getTransform:function(e,t){var i=1<arguments.length&&void 0!==t?t:!this.data.skipAnimation,r=this.data.full?2:1,a=this.data.full?e:e-1;return(0,_styleToCssString.default)({transition:i?"transform .3s":"none",transform:"translate(".concat(-50*r*Math.max(0,a),"%)")})},onTabsChange:function(e){var t=parseInt(e.detail.key),i=this.getTransform(t);this.data.bodyStyle===i&&this.data.activeIndex===t||(this.setData({bodyStyle:i,activeIndex:t}),this.triggerEvent("tabsChange",{index:t}))},onItemSelect:function(e){var t=e.currentTarget.dataset.optionIndex,i=e.detail.index,r=this.data.showOptions[t][i];this.updated(r,t,!this.data.controlled,this.onChange)},onChange:function(e,t){var i=0<arguments.length&&void 0!==e?e:{},r=1<arguments.length&&void 0!==t?t:[],a=this.getFieldName("children"),n=this.getValue(r);if(i&&!1===i.isLeaf&&!i[a])return this.triggerEvent("change",_objectSpread({},n)),void this.triggerEvent("load",{value:n.value,options:n.options});this.triggerEvent("change",_objectSpread({},n))},getValue:function(e){var t=0<arguments.length&&void 0!==e?e:this.data.activeValue,i=Math.max(0,t.length-1),r=this.getActiveOptions(t),a=r[i],n=this.getFieldName("value"),o=this.getFieldName("children"),s=a&&a[o]&&0<a[o].length,l=r.filter(function(e){return e[n]!==WUX_CASCADER_VIEW}),u=l.map(function(e){return e[n]});return a&&!1===a.isLeaf&&!a[o]?{value:u,options:l,done:!1}:{value:u,options:l,done:!s}},updateStyle:function(e){var t=(0,_styleToCssString.default)({height:e,minHeight:e});this.data.scrollViewStyle!==t&&this.setData({scrollViewStyle:t})}},attached:function(){var e=this.data,t=e.defaultValue,i=e.value,r=e.controlled,a=e.height,n=r?i:t;this.setData({activeValue:n}),this.getCurrentOptions(n),this.updateStyle(a)}});